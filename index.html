<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Optimal PM Interval</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
*, *::before, *::after { box-sizing: border-box; }

body {
  font-family: Arial, system-ui, sans-serif;
  margin: 20px;
  background: #ffffff;
}

/* ===== CARDS ===== */
.card {
  background:#F2F2F2;
  border:1px solid #e2e2e2;
  border-radius:14px;
  padding:22px 24px;
  margin-bottom:16px;
}

.card h3 {
  margin:0 0 16px 0;
  font-size:1.1rem;
}

/* ===== INPUTS ===== */
label {
  font-weight:600;
  margin-top:14px;
  margin-bottom:6px;
  display:block;
}

input {
  width:100%;
  padding:11px 12px;
  border-radius:8px;
  border:1px solid #d0d0d0;
}

/* ===== BUTTONS ===== */
button {
  padding:10px 16px;
  font-weight:700;
  border-radius:10px;
  border:none;
  cursor:pointer;
  background:#000;
  color:#fff;
  margin-top:12px;
  margin-right:8px;
}

/* ===== RESULTS GRID ===== */
.results-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:14px;
}

.result-tile {
  background:#ffffff;
  border:1px solid #e2e2e2;
  border-radius:12px;
  padding:16px;
  text-align:center;
}

.result-label {
  font-size:12px;
  font-weight:600;
  color:#666;
}

.result-value {
  font-size:18px;
  font-weight:700;
  margin-top:6px;
}

/* ===== CHARTS ===== */
canvas {
  background:#fff;
  border:1px solid #e2e2e2;
  border-radius:8px;
  width:100%;
  max-height:280px;
}
</style>
</head>

<body>

<!-- ===== DATA ENTRY ===== -->
<div class="card">
  <h3>Data Entry</h3>

  <label>Weibull β</label><input id="beta" type="number" value="2">
  <label>Weibull η (hrs)</label><input id="eta" type="number" value="500">
  <label>Unplanned Cost ($/hr)</label><input id="c_unplanned" type="number" value="20000">
  <label>Planned Cost ($/hr)</label><input id="c_planned" type="number" value="5000">
  <label>Unplanned Downtime (hrs)</label><input id="downtime_unplanned" type="number" value="6">
  <label>Planned Downtime (hrs)</label><input id="duration_planned" type="number" value="3">
  <label>Simulation Period (hrs)</label><input id="horizon" type="number" value="5000">
  <label>Monte Carlo Simulations</label><input id="reps" type="number" value="1000">
  <label>Evaluation Points</label><input id="grid" type="number" value="40">

  <button id="run">Run Simulation</button>
  <button id="clear">Clear Results</button>
</div>

<!-- ===== RESULTS ===== -->
<div class="card">
  <h3>Results</h3>

  <div class="results-grid">
    <div class="result-tile">
      <div class="result-label">Optimal PM Interval</div>
      <div id="sumInterval" class="result-value">–</div>
    </div>
    <div class="result-tile">
      <div class="result-label">Total Cost</div>
      <div id="sumCost" class="result-value">–</div>
    </div>
    <div class="result-tile">
      <div class="result-label">Planned Events</div>
      <div id="sumPlanned" class="result-value">–</div>
    </div>
    <div class="result-tile">
      <div class="result-label">Unplanned Events</div>
      <div id="sumUnplanned" class="result-value">–</div>
    </div>
    <div class="result-tile">
      <div class="result-label">Availability</div>
      <div id="sumAvail" class="result-value">–</div>
    </div>
    <div class="result-tile">
      <div class="result-label">Simulation Time</div>
      <div id="sumTime" class="result-value">–</div>
    </div>
  </div>
</div>

<!-- ===== CHARTS ===== -->
<div class="card">
  <h3>Total Cost vs PM Interval</h3>
  <canvas id="chartCost"></canvas>
</div>

<div class="card">
  <h3>Planned vs Unplanned Cost</h3>
  <canvas id="chartPUcost"></canvas>
</div>

<div class="card">
  <h3>Planned vs Unplanned Events</h3>
  <canvas id="chartPUevents"></canvas>
</div>

<!-- ===== JAVASCRIPT (UNCHANGED) ===== -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const beta = document.getElementById("beta");
  const eta = document.getElementById("eta");
  const cU = document.getElementById("c_unplanned");
  const cP = document.getElementById("c_planned");
  const du = document.getElementById("downtime_unplanned");
  const dp = document.getElementById("duration_planned");
  const h = document.getElementById("horizon");
  const reps = document.getElementById("reps");
  const grid = document.getElementById("grid");

  const sumInterval = document.getElementById("sumInterval");
  const sumCost = document.getElementById("sumCost");
  const sumPlanned = document.getElementById("sumPlanned");
  const sumUnplanned = document.getElementById("sumUnplanned");
  const sumAvail = document.getElementById("sumAvail");
  const sumTime = document.getElementById("sumTime");

  const chartCostCanvas = document.getElementById("chartCost");
  const chartPUcostCanvas = document.getElementById("chartPUcost");
  const chartPUeventsCanvas = document.getElementById("chartPUevents");

  let chartCost, chartPUcost, chartPUevents;

  function weibull(b,e){
    const u=Math.min(Math.max(Math.random(),1e-12),1-1e-12);
    return e*Math.pow(-Math.log(1-u),1/b);
  }

  function simulate({b,e,h,du,dp,pm}){
    let t=0,p=0,u=0,d=0;
    while(t<h){
      const x=weibull(b,e);
      if(x<pm){u++;d+=du;t+=x+du;}
      else{p++;d+=dp;t+=pm+dp;}
    }
    return{p,u,d};
  }

  function evalOne(o){
    let P=0,U=0,D=0;
    for(let i=0;i<o.reps;i++){
      const r=simulate({b:o.b,e:o.e,h:o.h,du:o.du,dp:o.dp,pm:o.f});
      P+=r.p;U+=r.u;D+=r.d;
    }
    P/=o.reps;U/=o.reps;D/=o.reps;
    return{
      freq:o.f,
      planned:P,
      unplanned:U,
      plannedCost:P*o.cP*o.dp,
      unplannedCost:U*o.cU*o.du,
      totalCost:(P*o.cP*o.dp)+(U*o.cU*o.du),
      availability:1-(D/o.h)
    };
  }

  function sweep(o){
    const rows=[],min=o.e*0.1,max=o.e*3,step=(max-min)/(o.grid-1);
    for(let i=0;i<o.grid;i++)rows.push(evalOne({...o,f:min+i*step}));
    return rows;
  }

  document.getElementById("run").onclick=()=>{
    const t0=performance.now();
    const o={b:+beta.value,e:+eta.value,cU:+cU.value,cP:+cP.value,du:+du.value,dp:+dp.value,h:+h.value,reps:+reps.value,grid:+grid.value};
    const rows=sweep(o);

    if(chartCost)chartCost.destroy();
    if(chartPUcost)chartPUcost.destroy();
    if(chartPUevents)chartPUevents.destroy();

    chartCost=new Chart(chartCostCanvas,{type:"line",data:{datasets:[{label:"Total Cost",data:rows.map(r=>({x:r.freq,y:r.totalCost})),borderColor:"#000",backgroundColor:"#000",borderWidth:3}]},options:{scales:{x:{type:"linear"},y:{min:0}}}});
    chartPUcost=new Chart(chartPUcostCanvas,{type:"line",data:{datasets:[{label:"Planned Cost",data:rows.map(r=>({x:r.freq,y:r.plannedCost})),borderColor:"#22c55e",backgroundColor:"#22c55e"},{label:"Unplanned Cost",data:rows.map(r=>({x:r.freq,y:r.unplannedCost})),borderColor:"#ef4444",backgroundColor:"#ef4444"}]},options:{scales:{x:{type:"linear"},y:{min:0}}}});
    chartPUevents=new Chart(chartPUeventsCanvas,{type:"bar",data:{labels:rows.map(r=>r.freq.toFixed(0)),datasets:[{label:"Planned Events",data:rows.map(r=>r.planned),backgroundColor:"#22c55e"},{label:"Unplanned Events",data:rows.map(r=>r.unplanned),backgroundColor:"#ef4444"}]},options:{scales:{x:{stacked:true},y:{stacked:true,min:0}}}});

    const best=rows.reduce((a,b)=>a.totalCost<b.totalCost?a:b);
    sumInterval.textContent=best.freq.toFixed(1)+" hrs";
    sumCost.textContent="$"+best.totalCost.toFixed(0);
    sumPlanned.textContent=best.planned.toFixed(2);
    sumUnplanned.textContent=best.unplanned.toFixed(2);
    sumAvail.textContent=(best.availability*100).toFixed(1)+"%";
    sumTime.textContent=(performance.now()-t0).toFixed(0)+" ms";
  };

  document.getElementById("clear").onclick=()=>{
    [sumInterval,sumCost,sumPlanned,sumUnplanned,sumAvail,sumTime].forEach(e=>e.textContent="–");
    if(chartCost){chartCost.destroy();chartCost=null;}
    if(chartPUcost){chartPUcost.destroy();chartPUcost=null;}
    if(chartPUevents){chartPUevents.destroy();chartPUevents=null;}
  };

});
</script>

<script>
  let heightTimeout;

  function sendHeight() {
    clearTimeout(heightTimeout);
    heightTimeout = setTimeout(() => {
      const height = document.documentElement.scrollHeight;
      window.parent.postMessage({ height }, "*");
    }, 50);
  }

  window.addEventListener("load", sendHeight);
  window.addEventListener("resize", sendHeight);

  const observer = new MutationObserver(sendHeight);
  observer.observe(document.body, {
    childList: true,
    subtree: true,
    attributes: true
  });
</script>
</body>
</html>

